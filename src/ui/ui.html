<!DOCTYPE html>
<html>
<head>
  <style>
    body { 
      font-family: Inter, Arial, sans-serif; 
      margin: 0; 
      padding: 16px; 
      background: #fafbfc; 
    }
    textarea { 
      width: 100%; 
      min-height: 120px; 
      margin-bottom: 12px; 
      font-family: monospace; 
      font-size: 14px; 
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button { 
      padding: 8px 20px; 
      font-size: 16px; 
      background: #007bff; 
      color: #fff; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      width: 100%;
    }
    button:hover {
      background: #0056b3;
    }
    .status { 
      margin-top: 16px; 
      min-height: 24px; 
      color: #333; 
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>CodeToFigma</h2>
    <label for="html-input">HTML:</label>
    <textarea id="html-input" placeholder="Paste HTML here..."></textarea>
    
    <label for="css-input">CSS:</label>
    <textarea id="css-input" placeholder="Paste CSS here..."></textarea>
    
    <button id="convert-btn">Convert to Figma</button>
    <div class="status" id="status"></div>
  </div>

  <script>
    const htmlInput = document.getElementById('html-input');
    const cssInput = document.getElementById('css-input');
    const convertBtn = document.getElementById('convert-btn');
    const statusDiv = document.getElementById('status');

    // Function to collect computed styles from rendered HTML
    function collectComputedStyles(element) {
      const computed = window.getComputedStyle(element);
      const rect = element.getBoundingClientRect();
      
      // Skip text nodes and comments
      if (element.nodeType !== 1) return null;
      
      // Collect all computed properties we need
      const data = {
        tagName: element.tagName.toLowerCase(),
        textContent: element.childNodes.length === 1 && 
                     element.childNodes[0].nodeType === 3 ? 
                     element.childNodes[0].textContent : null,
        rect: {
          width: rect.width,
          height: rect.height,
          x: rect.x,
          y: rect.y
        },
        computedStyles: {
          // Layout
          display: computed.display,
          position: computed.position,
          flexDirection: computed.flexDirection,
          justifyContent: computed.justifyContent,
          alignItems: computed.alignItems,
          flexWrap: computed.flexWrap,
          gap: computed.gap,
          
          // Sizing
          width: computed.width,
          height: computed.height,
          minWidth: computed.minWidth,
          maxWidth: computed.maxWidth,
          minHeight: computed.minHeight,
          maxHeight: computed.maxHeight,
          flexGrow: computed.flexGrow,
          flexShrink: computed.flexShrink,
          flexBasis: computed.flexBasis,
          
          // Spacing
          marginTop: computed.marginTop,
          marginRight: computed.marginRight,
          marginBottom: computed.marginBottom,
          marginLeft: computed.marginLeft,
          paddingTop: computed.paddingTop,
          paddingRight: computed.paddingRight,
          paddingBottom: computed.paddingBottom,
          paddingLeft: computed.paddingLeft,
          
          // Visual
          backgroundColor: computed.backgroundColor,
          backgroundImage: computed.backgroundImage,
          opacity: computed.opacity,
          
          // Border
          borderTopWidth: computed.borderTopWidth,
          borderRightWidth: computed.borderRightWidth,
          borderBottomWidth: computed.borderBottomWidth,
          borderLeftWidth: computed.borderLeftWidth,
          borderTopColor: computed.borderTopColor,
          borderRightColor: computed.borderRightColor,
          borderBottomColor: computed.borderBottomColor,
          borderLeftColor: computed.borderLeftColor,
          borderTopLeftRadius: computed.borderTopLeftRadius,
          borderTopRightRadius: computed.borderTopRightRadius,
          borderBottomRightRadius: computed.borderBottomRightRadius,
          borderBottomLeftRadius: computed.borderBottomLeftRadius,
          
          // Text
          color: computed.color,
          fontSize: computed.fontSize,
          fontFamily: computed.fontFamily,
          fontWeight: computed.fontWeight,
          fontStyle: computed.fontStyle,
          lineHeight: computed.lineHeight,
          letterSpacing: computed.letterSpacing,
          textAlign: computed.textAlign,
          textTransform: computed.textTransform,
          
          // Effects
          boxShadow: computed.boxShadow,
          filter: computed.filter
        },
        children: []
      };
      
      // Recursively collect children
      for (const child of element.children) {
        const childData = collectComputedStyles(child);
        if (childData) {
          data.children.push(childData);
        }
      }
      
      return data;
    }

    // Update the convert button handler
    convertBtn.onclick = () => {
      console.log('üöÄ Convert button clicked');
      statusDiv.textContent = 'Converting...';
      
      const html = htmlInput.value.trim();
      const css = cssInput.value.trim();
      
      if (!html) {
        statusDiv.textContent = '‚ùå Please enter some HTML';
        return;
      }
      
      // Create a hidden iframe to render the HTML/CSS
      const iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.left = '-9999px';
      iframe.style.width = '1400px'; // Match your target width
      iframe.style.height = '1000px';
      document.body.appendChild(iframe);
      
      try {
        // Write HTML and CSS to iframe
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <style>${css}</style>
            </head>
            <body style="margin: 0; padding: 0;">
              ${html}
            </body>
          </html>
        `);
        iframeDoc.close();
        
        // Wait for render, then collect styles
        setTimeout(() => {
          try {
            const rootElement = iframeDoc.body.firstElementChild;
            if (rootElement) {
              console.log('üìä Collecting computed styles...');
              const computedData = collectComputedStyles(rootElement);
              console.log('üì§ Sending computed data to plugin');
              
              // Send to plugin
              parent.postMessage({
                pluginMessage: {
                  type: 'create-from-computed',
                  data: computedData
                }
              }, '*');
            } else {
              statusDiv.textContent = '‚ùå No root element found in HTML';
            }
          } catch (error) {
            console.error('Error collecting styles:', error);
            statusDiv.textContent = '‚ùå Error: ' + error.message;
          } finally {
            // Cleanup
            document.body.removeChild(iframe);
          }
        }, 100); // Small delay to ensure rendering
      } catch (error) {
        console.error('Error creating iframe:', error);
        statusDiv.textContent = '‚ùå Error: ' + error.message;
        if (iframe.parentNode) {
          document.body.removeChild(iframe);
        }
      }
    };

    window.onmessage = (event) => {
      console.log('üì® Received message:', event.data);
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      console.log('üîÑ Plugin message:', msg);
      
      if (msg.type === 'success') {
        console.log('‚úÖ Conversion successful');
        statusDiv.textContent = '‚úÖ Conversion complete!';
      } else if (msg.type === 'error') {
        console.log('‚ùå Conversion error:', msg.message);
        statusDiv.textContent = '‚ùå Error: ' + msg.message;
      }
    };
  </script>
</body>
</html>